# Agent Architecture - Claude Agent SDK

Claude Agent SDKにおけるエージェント拡張アーキテクチャの包括的リファレンス。サブエージェント、MCP、カスタムツール、プラグイン、Skillsの設計判断に必要な情報をまとめる。

---

## サブファイル一覧

| ファイル | 内容 |
|:--------|:-----|
| [subagents.md](./subagents.md) | サブエージェントの作成方法、AgentDefinition設定、動的エージェント設定、呼び出し方式、再開 |
| [mcp.md](./mcp.md) | MCPで外部ツールに接続する方法、トランスポートタイプ、ツール検索、認証、エラーハンドリング |
| [custom-tools.md](./custom-tools.md) | カスタムツールの作成と使用、型安全性（Zodスキーマ）、エラーハンドリング、実用例 |
| [plugins-and-skills.md](./plugins-and-skills.md) | プラグインの読み込みと構造、Agent Skillsの定義・検出・呼び出し、トラブルシューティング |

---

## 設計判断ポイント

### 拡張メカニズムの比較

| 観点 | サブエージェント | MCP | カスタムツール | プラグイン | Skills |
|:-----|:------------|:----|:-----------|:---------|:-------|
| **定義方式** | プログラム的 or ファイル | 設定ファイル or コード | コード内 | ファイルシステム | ファイルシステム (SKILL.md) |
| **実行場所** | 独立したエージェントインスタンス | 外部プロセス or リモート | インプロセス | パッケージ全体 | メインエージェント内 |
| **コンテキスト** | 分離（独自コンテキスト） | 共有（メインエージェント内） | 共有（メインエージェント内） | パッケージ依存 | 共有（メインエージェント内） |
| **呼び出し方式** | Taskツール経由（自動/明示的） | ツール呼び出し | ツール呼び出し | コマンド/自動 | Claudeが自律的に選択 |
| **モデル選択** | エージェントごとに指定可能 | メインモデル | メインモデル | パッケージ依存 | メインモデル |
| **ツール制限** | エージェントごとに制限可能 | allowedToolsで制御 | allowedToolsで制御 | パッケージ内で定義 | allowedToolsで制御 |
| **並列実行** | 可能 | 不可（ツール単位） | 不可（ツール単位） | 不可 | 不可 |
| **プログラムAPI** | あり | あり | あり | なし（ファイルパス指定） | なし（ファイルシステムのみ） |

### いつ何を使うか

| シナリオ | 推奨 | 理由 |
|:--------|:-----|:-----|
| 複雑なタスクを並列で処理したい | **サブエージェント** | 独立したコンテキストで同時実行可能 |
| メインコンテキストを汚染せずに探索したい | **サブエージェント** | コンテキスト分離により情報過多を防止 |
| 既存の外部サービス/APIに接続したい | **MCP** | 既製のMCPサーバーが多数利用可能 |
| 大量のツールがある | **MCP** + ツール検索 | オンデマンドでツールをロードしコンテキスト節約 |
| アプリケーション固有のロジックをツール化したい | **カスタムツール** | インプロセスで型安全に定義可能 |
| チームで共有するワークフローをパッケージ化したい | **プラグイン** | コマンド、エージェント、スキル、フック、MCPを一括管理 |
| Claudeに自律的に判断させたい | **Skills** | descriptionに基づきClaudeが適切に呼び出し |
| ファイルシステムなしで動的にツールを定義したい | **カスタムツール** or **サブエージェント** | プログラムAPIで定義可能 |
| 読み取り専用の分析を安全に委任したい | **サブエージェント** + ツール制限 | `tools: ["Read", "Grep", "Glob"]` で制約 |
| モデルを使い分けたい（コスト/品質） | **サブエージェント** | `model` フィールドでエージェントごとに指定 |

### allowedToolsの設計パターン

| 必要なツール | 設定 |
|:-----------|:-----|
| サブエージェント呼び出し | `"Task"` を含める |
| Skills呼び出し | `"Skill"` を含める + `setting_sources` を設定 |
| MCPツール（全許可） | `"mcp__server-name__*"` |
| MCPツール（個別） | `"mcp__server-name__tool-name"` |
| パーミッション一括 | `permissionMode: "acceptEdits"` or `"bypassPermissions"` |

### ストリーミング入力の注意点

カスタムMCPツールを使用する場合、`prompt` に非同期ジェネレータ/イテラブルを使用する必要がある。単純な文字列はMCPサーバーでは動作しない。

### サブエージェントの制約

- サブエージェントは独自のサブエージェントを生成できない（ネスト不可）
- 各 `query()` はデフォルトで新しいセッション。再開には `resume: sessionId` が必要
- Windowsでは長いプロンプト（8191文字超）が失敗する場合がある
- ファイルシステムベースのエージェントは起動時にのみ読み込まれる

### Skills vs サブエージェント

| 観点 | Skills | サブエージェント |
|:-----|:-------|:------------|
| 定義 | ファイルシステムのみ (SKILL.md) | プログラム的 or ファイル |
| 呼び出し判断 | Claudeが自律的に判断 | 自動 or 明示的指定 |
| コンテキスト | メインエージェント内で共有 | 独立したコンテキスト |
| 並列実行 | 不可 | 可能 |
| モデル選択 | メインモデル固定 | エージェントごとに指定可能 |
| ツール制限 | SDK側の `allowedTools` で制御 | エージェントごとに `tools` で制限 |
| プログラムAPI | なし | あり |
