# System Configuration - Claude Agent SDK

Agent SDKにおけるシステム設定リファレンス。権限戦略、フックパターン、システムプロンプトカスタマイズ、スラッシュコマンド、Todoトラッキング、ファイルチェックポイントの設計判断に必要な情報を集約。

## サブファイル一覧

| ファイル | 内容 |
|---------|------|
| [hooks.md](./hooks.md) | フックの構成要素、利用可能なフック一覧、設定方法、コールバック入出力、権限決定フロー、フックパターン集、トラブルシューティング |
| [commands-and-todo.md](./commands-and-todo.md) | スラッシュコマンドの確認・送信・作成方法、カスタムコマンドの例、Todoトラッキングのライフサイクルと実装 |
| [checkpoints.md](./checkpoints.md) | ファイルチェックポイントの仕組み、対象ツール、実装フロー、複数復元ポイント、CLIからの巻き戻し、制限事項 |

---

## 1. 権限の設定

### 権限評価フロー

Claudeがツールをリクエストすると、SDKは以下の順序で権限をチェックする：

| 順序 | ステップ | 説明 |
|------|---------|------|
| 1 | フック | `PreToolUse`フックを実行し、許可・拒否・続行を判定 |
| 2 | 権限ルール | `settings.json`のルールを `deny` → `allow` → `ask` の順でチェック |
| 3 | 権限モード | アクティブな権限モードを適用 |
| 4 | `canUseTool`コールバック | ルールやモードで解決されない場合、コールバックで判断 |

### 権限モード一覧

| モード | 説明 | ツールの動作 |
|--------|------|-------------|
| `default` | 標準的な権限動作 | 自動承認なし。一致しないツールは`canUseTool`コールバックをトリガー |
| `acceptEdits` | ファイル編集を自動承認 | ファイル編集とファイルシステム操作（`mkdir`、`rm`、`mv`など）が自動承認 |
| `bypassPermissions` | すべての権限チェックをバイパス | すべてのツールが権限プロンプトなしで実行（注意して使用） |
| `plan` | 計画モード | ツールの実行なし。Claudeは変更を加えずに計画を立てる |

**サブエージェントの継承**: `bypassPermissions`を使用する場合、すべてのサブエージェントがこのモードを継承し、オーバーライドできない。サブエージェントはメインエージェントとは異なるシステムプロンプトを持ち、制約の少ない動作をする可能性がある。

### acceptEditsモードの詳細

自動承認される操作：
- ファイル編集（Edit、Writeツール）
- ファイルシステムコマンド：`mkdir`、`touch`、`rm`、`mv`、`cp`

**使用する場面**: Claudeの編集を信頼し、より高速なイテレーションを望む場合。プロトタイピング中や隔離されたディレクトリで作業する場合。

### 計画モード（`plan`）

ツールの実行を完全に防止する。Claudeはコードを分析して計画を作成できるが、変更を加えることはできない。Claudeは計画を確定する前に要件を明確にするために`AskUserQuestion`を使用する場合がある。

**使用する場面**: Claudeに変更を実行せずに提案させたい場合。コードレビュー中や、変更が行われる前に承認が必要な場合。

---

## 3. システムプロンプトの変更

Claudeの動作をカスタマイズする3つのアプローチ：

1. **出力スタイル**: 出力のフォーマットやスタイルを制御
2. **appendを使用したsystemPrompt**: 既存のシステムプロンプトに追加
3. **カスタムシステムプロンプト**: 完全にカスタムのシステムプロンプトを指定

---

## 設計判断ポイント

### 権限戦略の選択

| シナリオ | 推奨モード | 理由 |
|---------|-----------|------|
| プロトタイピング・隔離環境 | `acceptEdits` | ファイル編集を自動承認し高速イテレーション |
| CI/CD自動化 | `bypassPermissions` + フック | 全ツール自動承認だがフックでセキュリティ制御 |
| コードレビュー・計画段階 | `plan` | 変更を加えずに計画のみ |
| 本番環境 | `default` + 権限ルール + フック | 最も安全。宣言的ルールとフックで細粒度制御 |

### フック vs 権限ルール vs canUseTool の使い分け

| 方法 | 適用場面 |
|------|---------|
| **フック（PreToolUse）** | 動的なロジックが必要な場合（入力パラメータの検証、外部APIとの連携、ツール入力の変更） |
| **権限ルール（settings.json）** | 静的な許可/拒否で十分な場合（コード不要、宣言的に設定） |
| **canUseTool コールバック** | ユーザーにランタイムで承認を求めたい場合（インタラクティブなフロー） |

### フック設計のベストプラクティス

- **単一責任の原則**: 各フックを1つの責任に集中させ、複数フックをチェーンする
- **マッチャーの絞り込み**: 可能な限り`matcher`パターンで特定のツールをターゲットにする。空のマッチャーはすべてのツールに対して実行される
- **deny優先の評価**: いずれかのフックが`deny`を返した場合、他のフックが`allow`を返しても操作はブロックされる
- **サブエージェント考慮**: サブエージェントは親の権限を自動継承しない。`PreToolUse`フックで自動承認するか権限ルールを設定する
- **再帰ループの防止**: `UserPromptSubmit`フックでサブエージェントを生成する場合、`parent_tool_use_id`で検出して無限ループを防ぐ

### ファイルチェックポイントの活用パターン

| パターン | 適用場面 |
|---------|---------|
| **単一チェックポイント（最新のみ保持）** | リスクのある操作前にセーフポイントを設定し、問題時に即座に巻き戻す |
| **複数チェックポイント（全履歴保持）** | 複数ターンの変更から任意のポイントに巻き戻したい場合（リファクタリングは保持しテストだけ戻すなど） |
| **CLIからの巻き戻し** | セッションIDとチェックポイントIDを保存しておき、後からCLIで巻き戻す |

### スラッシュコマンド設計の指針

- **`allowed-tools`フロントマター**: コマンドで使用できるツールを制限し安全性を確保
- **`argument-hint`**: `$1`、`$2`、`$ARGUMENTS`でプレースホルダーを使用した動的な引数をサポート
- **`!`バッククォート**: Bashコマンドの実行結果をコンテキストとして注入
- **`@`プレフィックス**: ファイルの内容をコンテキストとして含める
- **名前空間**: サブディレクトリで整理。コマンド説明に表示されるがコマンド名には影響しない
- **スコープ**: プロジェクト固有（`.claude/commands/`）vs グローバル（`~/.claude/commands/`）を適切に選択
