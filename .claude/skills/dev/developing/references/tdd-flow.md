# TDDワークフロー詳細

## 4ステップワークフロー

```
┌─────────────────────────────────────────────────────────────────┐
│ ステップ1: TDDサイクル（RED→GREEN→REFACTOR）                    │
├─────────────────────────────────────────────────────────────────┤
│ tdd-cycleサブエージェント [sonnet] を使用                        │
│                                                                 │
│ Phase 1 - RED:                                                  │
│ - テストのみ作成（実装は書かない）                               │
│ - テスト実行 → 失敗を確認                                       │
│ - テストのみを先行コミット（git add + commit）                   │
│                                                                 │
│ Phase 2 - GREEN:                                                │
│ - テストを通す最小限の実装                                       │
│ - 実装戦略: 仮実装 → 三角測量 → 明白な実装                      │
│ - テスト実行 → 全パスまで反復（通常2-4周で収束）                  │
│ - ⚠️ テストは絶対に変更しない（仕様のブレ防止）                  │
│                                                                 │
│ Phase 3 - REFACTOR:                                             │
│ - Codex CLIで設計分析（フォールバック: チェックリスト）            │
│ - コード整理（明瞭性・一貫性・保守性の向上）                      │
│ - テスト実行 → 全パス確認                                       │
│ - 機能追加はしない                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ ステップ2: セルフレビュー + テスト資産管理                       │
├─────────────────────────────────────────────────────────────────┤
│ tdd-reviewサブエージェント [opus] を使用                         │
│                                                                 │
│ レビュー:                                                       │
│ - 過剰適合: テストケースだけに最適化されていないか                │
│ - 抜け道: テストをすり抜ける不具合・エッジケースがないか          │
│ - コード品質と保守性                                            │
│                                                                 │
│ テスト資産管理:                                                  │
│ - 長期的価値のあるテスト → 保持                                  │
│ - 重複・冗長なテスト → 簡素化（パラメータ化等）                   │
│ - 役割を終えたテスト → 削除（カバレッジ確認後）                   │
│                                                                 │
│ 問題あり → ステップ1に戻って修正                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ ステップ3: 品質チェック                                         │
├─────────────────────────────────────────────────────────────────┤
│ quality-checkサブエージェント [haiku] を使用                      │
│                                                                 │
│ - Lint: コード品質チェック                                      │
│ - Format: コードフォーマット（自動修正）                         │
│ - Build: ビルド/コンパイル確認                                  │
│                                                                 │
│ エラーあり → 自動修正可能ならquality-checkが修正                  │
│           → 自動修正不可ならステップ1に戻って調整                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ ステップ4: コミット                                             │
├─────────────────────────────────────────────────────────────────┤
│ simple-add-devサブエージェント [haiku] を使用                     │
│                                                                 │
│ 実装 + テスト資産管理の結果をコミット                             │
│                                                                 │
│ 完了 → タスク完了マーク                                         │
└─────────────────────────────────────────────────────────────────┘
```

## TODO.md でのラベル表記

```markdown
- [ ] [TDD][CYCLE] validateEmail のテスト作成・実装・リファクタリング
- [ ] [TDD][REVIEW] セルフレビュー + テスト資産管理
- [ ] [TDD][CHECK] lint/format/build
- [ ] [TDD][COMMIT] コミット
```

## 設計原則チェックリスト

| カテゴリ | チェック項目 | 確認内容 |
|----------|--------------|----------|
| **SOLID** | 単一責任原則 (SRP) | 1つの関数/モジュールが1つの責務のみ |
| | 依存性逆転原則 (DIP) | 具象ではなく抽象に依存 |
| | インターフェース分離原則 (ISP) | 使わないメソッドへの依存なし |
| **テスタビリティ** | 依存性注入 | 外部から注入可能 |
| | 純粋関数 | 副作用を分離 |
| | グローバル状態 | グローバル変数に依存しない |
| **構造** | 高凝集度 | 関連機能がまとまっている |
| | 低結合度 | モジュール間の依存が最小 |
| | 重複排除 (DRY) | 同じロジックが複数箇所にない |
| **シンプルさ** | YAGNI | 不要な抽象化なし |
| | KISS | 過度な複雑さなし |

## リファクタリングの優先順位

1. テスタビリティの確保（DI、純粋関数化）
2. 単一責任の徹底
3. 重複の排除
4. 命名の改善
