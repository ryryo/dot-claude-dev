# SKILL.md整理パターン集

dev:story SKILL.mdリファクタリング（366行→100行）で得た7パターン。

---

## 1. 圧縮パターン

**問題**: コード例、実例、判定基準、テンプレート等の詳細情報がSKILL.mdを肥大化させる。
**対策**: SKILL.mdから詳細を外部に委譲。委譲先は内容に応じて選択:
- **agents/**: エージェントが実行する処理の詳細（プロンプト、手順、出力形式）
- **references/**: 判定基準、コード例、実例、テンプレート、設定サンプル等の参照情報
**目安**: SKILL.mdは100行未満が理想。

### チェック項目
- [ ] コード例・実例・サンプル出力がSKILL.mdにないか → agents/ or references/
- [ ] 判定基準・分類ロジックがSKILL.mdにないか → references/
- [ ] テンプレート・出力形式の詳細がSKILL.mdにないか → agents/ or references/
- [ ] 設定例・設定サンプルがSKILL.mdにないか → references/

---

## 2. DRY化パターン

**問題**: 同じ構造（エージェント呼び出し等）が各ステップで繰り返される。
**対策**: 冒頭で共通パターンを1回定義し、各ステップでは1行で参照。

### 手法
- 呼び出しパターンをコードブロックで1回定義
- Step/agent/model/コンテキストの対応テーブルを冒頭に配置
- 各ステップでは `→ **エージェント委譲**（agent名 / model）` の1行で参照

### チェック項目
- [ ] 同じ構造が3回以上繰り返されていないか
- [ ] 繰り返し構造を冒頭テーブルに集約できないか

---

## 3. LLM行動制御パターン

**問題**: 自然言語で「Taskエージェントで分析」と書いても、LLMが説明文として読んで自分で実行してしまう。
**対策**: ①「自分でやらない」を明示 ②具体的なツール呼び出しコードを提示。

### 手法
- `⚠️ ...は必ずTaskエージェントに委譲する。自分で実行しない。` を冒頭に配置
- `Read(agent.md) → Task(prompt)` の実行可能なパターンをコードブロックで提示
- 各ステップで `→ **エージェント委譲**` と太字で強調

### チェック項目
- [ ] 委譲すべき処理に「自分でやらない」旨の明示があるか
- [ ] 具体的なツール呼び出しパターン（擬似コード）が提示されているか
- [ ] 自然言語の説明だけで終わっていないか

---

## 4. ゲート条件パターン

**問題**: LLMがPhaseをスキップしていきなり最終成果物を作成する。
**対策**: 各ステップ末尾にゲート条件を配置。

### 手法
- `**ゲート**: {ファイル}が存在しなければ次に進まない。` を各ステップ末尾に配置
- 中間成果物（JSON等）を必ずファイルとして保存させる

### チェック項目
- [ ] 各ステップに明示的なゲート条件があるか
- [ ] 中間成果物がファイルとして保存される設計か
- [ ] 最終ステップにだけ成果物があり、中間が空になっていないか

---

## 5. 責務分離パターン

**問題**: SKILL.mdにagents/やrules/側が持つべき情報が含まれている。
**対策**: SKILL.mdはオーケストレータに徹し、詳細をagents/やreferences/に移す。小タスクも別エージェントに切り出す。

### 手法
- SKILL.md: 「何をどの順でやるか」のみ
- agents/: エージェントが実行する処理の詳細（プロンプト、手順、出力形式）
- references/: 判定基準、コード例、実例、テンプレート等の参照情報
- 小タスク（Glob→類似判定等）もhaiku委譲で別agent.mdに切り出し

### チェック項目
- [ ] SKILL.mdに分類基準・判定ロジック等の詳細が含まれていないか → references/
- [ ] agents/やreferences/側で持つべき情報がSKILL.mdに重複していないか
- [ ] 3行以上のインライン処理がエージェント切り出し候補ではないか → agents/

---

## 6. 廃止・整理パターン

**問題**: 使われていない参照や冗長なコード例が残っている。
**対策**: 実際に使われているかを確認し、不要なものを削除。

### チェック項目
- [ ] 参照先ファイルが実際に存在するか
- [ ] 参照先ファイルが実際に使われているか（Globで確認）
- [ ] 冗長なコード例（選択肢のJSON例等）がないか
- [ ] 「または〜」で始まる代替パスが実際に使われているか

---

## 7. 構造化パターン

**問題**: SKILL.mdの役割が不明確で、詳細と概要が混在している。
**対策**: SKILL.mdを「オーケストレータ」として位置づけ直す。

### 理想構造（100行未満）
```
1. frontmatter（10-20行）
2. 委譲ルール定義（10-15行）: パターン + テーブル
3. 出力先（3行）
4. 実行手順（30-40行）: Step + ゲート条件
5. 完了条件（10行）
6. 参照（5行）
```

### チェック項目
- [ ] SKILL.mdが「何をどの順でやるか」に集中しているか
- [ ] 100行未満か
- [ ] 実行手順が最上位に明確に配置されているか
