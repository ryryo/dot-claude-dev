# Codex 利用ベストプラクティス

> **読み込み条件**: Codex委譲を実行する時
> **相対パス**: `references/codex-best-practices.md`

## 概要

Codex（GPT-5.2）を効果的に活用するためのベストプラクティス集。

---

## 1. タスク設計

### 良いタスクの特徴

| 特徴 | 説明 | 例 |
|------|------|-----|
| **具体的** | 曖昧さがない | ✅「TypeScriptでJWT認証のミドルウェアを作成」 |
| **自己完結** | 外部依存が少ない | ✅「以下のコードをレビュー」 |
| **明確な出力** | 期待する形式が明確 | ✅「Markdown形式で説明」 |
| **適切なスコープ** | 大きすぎない | ✅「1つの関数を生成」 |

### 避けるべきタスク

| パターン | 問題点 | 代替案 |
|----------|--------|--------|
| 「良い感じにして」 | 曖昧すぎる | 具体的な要件を列挙 |
| 「全部リファクタ」 | スコープが広すぎ | 範囲を限定 |
| 「バグを探して」 | 対象が不明 | 具体的なファイル/機能を指定 |
| 「最適化して」 | 基準が不明 | 最適化の観点を指定 |

---

## 2. コンテキスト準備

### 含めるべき情報

```markdown
# コンテキスト

## プロジェクト概要
- プロジェクト名: AIWorkflowOrchestrator
- 目的: AIワークフローの統合管理
- 技術スタック: TypeScript, Next.js, Electron

## 関連コード
（タスクに直接関連するコードのみ抜粋）

## コーディング規約
- 命名規則: camelCase
- 関数の長さ: 30行以内
- エラーハンドリング: 必須

## 制約
- 既存のAPIは変更しない
- 後方互換性を維持
```

### 含めるべきでない情報

| 除外項目 | 理由 |
|----------|------|
| APIキー、パスワード | セキュリティリスク |
| 無関係なコード | ノイズになる |
| 全ファイルの内容 | コンテキスト浪費 |
| 内部的な議論履歴 | 本質に関係ない |

### コンテキストサイズの目安

| サイズ | 推奨度 | 用途 |
|--------|--------|------|
| < 2,000文字 | ✅ 最適 | 単純なタスク |
| 2,000-10,000文字 | ⚠️ 注意 | 複雑なタスク |
| > 10,000文字 | ❌ 避ける | 分割を検討 |

---

## 3. プロンプト設計

### 効果的なプロンプト構造

```
## タスク
（何をしてほしいか）

## コンテキスト
（必要な背景情報）

## 制約
（守るべきルール）

## 出力形式
（期待する形式）

## 例（オプション）
（具体的な例）
```

### プロンプトの例

#### 良い例

```markdown
## タスク
以下のTypeScript関数をレビューし、改善点を指摘してください。

## コンテキスト
この関数はユーザー認証モジュールの一部で、
JWTトークンの検証を行います。

## 制約
- セキュリティの観点を重視
- パフォーマンスへの影響も考慮
- 既存のAPIシグネチャは変更しない

## 出力形式
1. 問題点（重要度: High/Medium/Low）
2. 改善提案
3. 修正後のコード例

## 対象コード
```typescript
export function verifyToken(token: string): boolean {
  // ... コード
}
```

#### 悪い例

```
このコードを見て何か問題があれば教えて
```

---

## 4. 結果の検証

### 検証チェックリスト

| 項目 | 確認内容 |
|------|----------|
| **構文** | コードが正しくパースできるか |
| **型** | TypeScriptの型エラーがないか |
| **論理** | ビジネスロジックが正しいか |
| **スタイル** | コーディング規約に従っているか |
| **セキュリティ** | 脆弱性がないか |
| **テスト** | テストがパスするか |

### 自動検証スクリプト

```bash
# 構文チェック（TypeScript）
npx tsc --noEmit

# Lint
pnpm lint

# テスト
pnpm test
```

---

## 5. エラーハンドリング

### よくあるエラーと対処

| エラー | 原因 | 対処 |
|--------|------|------|
| タイムアウト | タスクが複雑すぎる | タスクを分割 |
| 不完全な出力 | コンテキスト不足 | コンテキスト追加 |
| 的外れな回答 | プロンプトが曖昧 | プロンプト明確化 |
| API エラー | サービス障害 | リトライ |

### リトライ戦略

```javascript
// 指数バックオフ
const delays = [1000, 2000, 4000, 8000];

for (const delay of delays) {
  try {
    return await executeCodex(task);
  } catch (error) {
    if (isRetryable(error)) {
      await sleep(delay);
      continue;
    }
    throw error;
  }
}
```

---

## 6. セキュリティ考慮事項

### 絶対に渡さない情報

| 情報種別 | 例 |
|----------|-----|
| 認証情報 | APIキー、パスワード、トークン |
| 個人情報 | メールアドレス、電話番号 |
| 機密データ | 顧客情報、財務データ |
| インフラ情報 | サーバーIP、内部URL |

### 安全なコンテキスト共有

```markdown
## 安全な例
- 公開可能なコード
- 一般的な設計パターン
- 匿名化されたサンプルデータ

## 危険な例
- .env ファイルの内容
- データベース接続文字列
- 本番環境の設定
```

---

## 7. パフォーマンス最適化

### タスク分割の指針

| 元タスク | 分割案 |
|----------|--------|
| 「全ファイルをレビュー」 | ファイルごとに分割 |
| 「アプリ全体を設計」 | 機能ごとに分割 |
| 「大量のテスト生成」 | モジュールごとに分割 |

### 並列実行

```bash
# 複数タスクを並列実行（注意: API制限に注意）
task1 &
task2 &
task3 &
wait
```

---

## 8. 結果の統合

### Claude Codeでの統合手順

1. **結果の確認**
   - codex-response.md を読み込み
   - 内容の妥当性を検証

2. **適用判断**
   - 直接適用可能か
   - 修正が必要か
   - 却下すべきか

3. **実装**
   - Claude Codeでファイル編集
   - テスト実行
   - コミット

### 統合時の注意点

| 注意点 | 理由 |
|--------|------|
| 盲目的に適用しない | Codexの出力は検証が必要 |
| 差分を確認する | 意図しない変更を防ぐ |
| テストを実行する | 品質を担保する |
| 段階的に適用する | 問題発生時の切り分け |

---

## 変更履歴

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-01-15 | 初版作成 |
